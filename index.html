<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Math Keyboard (Nested Fractions)</title>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 8px; background:#fff; }
    .shell { max-width: 260px; }
    textarea { width: 100%; height: 50px; font-size: 16px; box-sizing: border-box; }
    .preview {
      border: 1px solid #ccc; padding: 2px 4px; min-height: 24px; margin-top: 6px;
      font-size: 16px; line-height: 1.4; background: #fff; box-sizing: border-box;
      user-select: text;
    }
    .copyrow { display:flex; gap:6px; align-items:center; margin:6px 0; }
    .btn-copy, .btn-send {
      flex: 1 1 auto; height: 32px; padding: 0 10px; font-size: 14px;
      border: 1px solid #cfd3d9; border-radius: 6px; background:#fff; cursor:pointer;
    }
    .wrap { background: #ABA9D3; border-radius: 8px; padding: 6px; margin-top: 6px; }
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
    .btn {
      height: 40px; font-size: 16px; display:flex; align-items:center; justify-content:center;
      border: 1px solid #cfd3d9; border-radius: 6px; cursor:pointer; user-select:none; background:#fff;
    }
    .btn:active { transform: translateY(1px); }
    .row { display:grid; grid-template-columns: repeat(4, 1fr); gap:6px; margin-top:6px; }
    .toast {
      position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
      background: #111; color:#fff; padding:6px 10px; border-radius: 6px; font-size: 12px;
      opacity: 0; transition: opacity .2s ease;
    }
    .toast.show { opacity: 0.95; }
  </style>
</head>
<body>
  <div class="shell">
    <textarea id="input" placeholder="Type or use the keys..." oninput="updatePreview()"></textarea>
    <div class="preview" id="preview"></div>
    <div class="copyrow">
      <button class="btn-copy" onclick="copyUnicode()">Copy</button>
      <button class="btn-send" onclick="sendUnicode()">Send</button>
    </div>

    <div class="wrap">
      <div class="grid">
        <div class="btn" onclick="sendInsert(' + ')">+</div>
        <div class="btn" onclick="sendInsert(' - ')">−</div>
        <div class="btn" onclick="sendInsert('\\times')">×</div>
        <div class="btn" onclick="sendInsert(' : ')">:</div>
        <div class="btn" onclick="sendInsert(' = ')">=</div>
        <div class="btn" onclick="sendInsert('\\neq')">≠</div>
        <div class="btn" onclick="sendInsert('\\approx')">≈</div>
        <div class="btn" onclick="sendInsert('\\equiv')">≡</div>
        <div class="btn" onclick="sendInsert('^{2}')">x²</div>
        <div class="btn" onclick="sendInsert('^{3}')">x³</div>
        <div class="btn" onclick="sendInsertMove('^{ }', -2)">xⁿ</div>
        <div class="btn" onclick="sendInsertMove(' \\frac{}{}', -3)">a⁄b</div>
        <div class="btn" onclick="sendInsertMove(' \\sqrt{}', -1)">√</div>
        <div class="btn" onclick="sendInsertMove(' \\sqrt[n]{}', -1)">ⁿ√</div>
        <div class="btn" onclick="sendInsert(' < ')">&lt;</div>
        <div class="btn" onclick="sendInsert(' > ')">&gt;</div>
        <div class="btn" onclick="sendInsert('(')">(</div>
        <div class="btn" onclick="sendInsert(')')">)</div>
        <div class="btn" onclick="sendInsert('[')">[</div>
        <div class="btn" onclick="sendInsert(']')">]</div>
      </div>
      <div class="row">
        <div class="btn" onclick="sendInsert('.')">.</div>
        <div class="btn" onclick="sendAction('back')">←</div>
        <div class="btn" onclick="sendInsert(' ')">Space</div>
        <div class="btn" onclick="sendAction('clear')">Clear</div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Copied</div>

<script>
  const TARGET = null; // change to "MathEntry1" etc. if needed
  function post(msg){ try{ parent.postMessage(msg,"*"); }catch(e){} }
  function toast(msg){ const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1000); }
  function updatePreview(){ const src=document.getElementById('input').value;const prev=document.getElementById('preview');prev.innerHTML=src.trim()?('\\('+src+'\\)'):'';if(window.MathJax&&MathJax.typesetPromise)MathJax.typesetPromise([prev]); }

  /* -------- LaTeX → Unicode converter (nested safe) -------- */
  const SUP={'0':'⁰','1':'¹','2':'²','3':'³','4':'⁴','5':'⁵','6':'⁶','7':'⁷','8':'⁸','9':'⁹','+':'⁺','-':'⁻','(':'⁽',')':'⁾','n':'ⁿ'};
  const SUB={'0':'₀','1':'₁','2':'₂','3':'₃','4':'₄','5':'₅','6':'₆','7':'₇','8':'₈','9':'₉','+':'₊','-':'₋','(':'₍',')':'₎'};
  const OPS={'\\times':'×','\\cdot':'·','\\pm':'±','\\div':'÷','\\le':'≤','\\leq':'≤','\\ge':'≥','\\geq':'≥','\\neq':'≠','\\approx':'≈','\\equiv':'≡'};
  const VULGAR={'1/2':'½','1/3':'⅓','2/3':'⅔','1/4':'¼','3/4':'¾'};
  function toSup(s){return s.split('').map(ch=>SUP[ch]||ch).join('');}
  function toSub(s){return s.split('').map(ch=>SUB[ch]||ch).join('');}
  function readGroup(s,i){if(s[i]!=='{')return[null,i];let d=0,j=i,o='';for(;j<s.length;j++){let c=s[j];if(c==='{' ){if(d++>0)o+=c;}else if(c==='}'){if(--d===0){j++;break;}else o+=c;}else o+=c;}return[o,j];}
  function readBracket(s,i){if(s[i]!=='[')return[null,i];let d=0,j=i,o='';for(;j<s.length;j++){let c=s[j];if(c==='['){if(d++>0)o+=c;}else if(c===']'){if(--d===0){j++;break;}else o+=c;}else o+=c;}return[o,j];}
  function latexToUnicode(src){let s=(src||'').trim();Object.keys(OPS).forEach(k=>{s=s.replaceAll(k,OPS[k]);});let i=0,out='';while(i<s.length){if(s.startsWith('\\frac',i)){i+=5;while(s[i]===' ')i++;let num='',den='';if(s[i]==='{'){let[n,ni]=readGroup(s,i);i=ni;num=latexToUnicode(n);while(s[i]===' ')i++;if(s[i]==='{'){let[d,di]=readGroup(s,i);i=di;den=latexToUnicode(d);}}let key=`${num}/${den}`.replace(/\s+/g,'');out+=(VULGAR[key]||num+'⁄'+den);continue;}if(s.startsWith('\\sqrt',i)){i+=5;while(s[i]===' ')i++;let idx=null;if(s[i]==='['){let[br,bi]=readBracket(s,i);i=bi;idx=br;}while(s[i]===' ')i++;let rad='';if(s[i]==='{'){let[rg,ri]=readGroup(s,i);i=ri;rad=latexToUnicode(rg);}out+=(idx?toSup(latexToUnicode(idx)):'')+'√('+rad+')';continue;}if(s[i]==='^'){i++;if(s[i]==='{'){let[g,gi]=readGroup(s,i);i=gi;out+=toSup(latexToUnicode(g));}else{out+=toSup(s[i]||'');i++;}continue;}if(s[i]==='_'){i++;if(s[i]==='{'){let[g,gi]=readGroup(s,i);i=gi;out+=toSub(latexToUnicode(g));}else{out+=toSub(s[i]||'');i++;}continue;}out+=s[i++];}return out.replace(/\s+/g,' ').trim();}

  /* -------- Copy / Send -------- */
  async function copyUnicode(){const src=document.getElementById('input').value;const text=latexToUnicode(src);try{if(navigator.clipboard&&window.isSecureContext){await navigator.clipboard.writeText(text);}else{const ta=document.createElement('textarea');ta.value=text;document.body.appendChild(ta);ta.focus();ta.select();document.execCommand('copy');document.body.removeChild(ta);}toast("Copied: "+text);}catch(e){toast("Copy failed");}}
  function sendUnicode(){const src=document.getElementById('input').value;const text=latexToUnicode(src);post({type:"LATEX_SET",value:text,target:TARGET});toast("Sent: "+text);}

  /* -------- Keypad -------- */
  function insertIntoLocal(t){const input=document.getElementById('input');const s=input.selectionStart,e=input.selectionEnd;input.value=input.value.slice(0,s)+t+input.value.slice(e);input.selectionStart=input.selectionEnd=s+t.length;updatePreview();}
  function backspaceLocal(){const input=document.getElementById('input');const s=input.selectionStart,e=input.selectionEnd;if(s!==e){input.value=input.value.slice(0,s)+input.value.slice(e);input.selectionStart=input.selectionEnd=s;}else if(s>0){input.value=input.value.slice(0,s-1)+input.value.slice(e);input.selectionStart=input.selectionEnd=s-1;}updatePreview();}
  function clearLocal(){document.getElementById('input').value='';updatePreview();}
  function sendInsert(t){insertIntoLocal(t);}
  function sendInsertMove(t,m){insertIntoLocal(t);const input=document.getElementById('input');input.selectionStart=input.selectionEnd=input.selectionEnd+m;updatePreview();}
  function sendAction(k){if(k==='back')backspaceLocal();if(k==='clear')clearLocal();}
  window.addEventListener('load', updatePreview);
</script>
</body>
</html>
